name: deploy-pages

on:
  push:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: true

jobs:
  # ── 1a. Record human-mode scenario videos (with narration) ──
  record-human:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js (LTS)
        uses: actions/setup-node@v4
        with:
          node-version: lts/*

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10.29.3

      - name: Install system deps
        run: |
          sudo apt-get update
          sudo apt-get install -y xvfb xterm ffmpeg mc htop vim

      - name: Install deps
        run: pnpm install --frozen-lockfile

      - name: Install Playwright browsers
        run: npx playwright install --with-deps chromium

      - name: Record all scenarios (human mode)
        env:
          NODE_OPTIONS: '--experimental-transform-types'
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          export DISPLAY=:99
          Xvfb :99 -screen 0 1920x1080x24 &
          sleep 2

          scenarios=(basic-ui collab kanban tui-terminals console-logs github-mobile)
          for s in "${scenarios[@]}"; do
            echo "════════════════════════════════════════"
            echo " Recording: $s (human mode)"
            echo "════════════════════════════════════════"
            node tests/scenarios/$s.test.ts \
              || echo "⚠ Scenario $s failed (non-fatal)"
          done

          # Flatten artifact dirs: copy run.mp4 and captions.vtt into videos/<name>/
          mkdir -p videos
          for dir in artifacts/*.test-*; do
            name=$(basename "$dir" | sed 's/\.test-.*//')
            mkdir -p "videos/$name"
            cp "$dir"/run.mp4 "videos/$name/run.mp4" 2>/dev/null || true
            cp "$dir"/captions.vtt "videos/$name/captions.vtt" 2>/dev/null || true
          done

      - name: Upload human-mode videos
        uses: actions/upload-artifact@v4
        with:
          name: scenario-videos-human
          path: videos/
          if-no-files-found: warn

  # ── 1b. Record fast-mode scenario videos in Docker (no narration) ──
  record-fast-docker:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker image (cached)
        uses: docker/build-push-action@v6
        with:
          context: .
          load: true
          tags: b2v-pages:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Record all scenarios (fast mode, Docker)
        run: |
          mkdir -p artifacts
          docker run --rm \
            --ipc=host \
            -e B2V_MODE=fast \
            -e DISPLAY=:99 \
            -v ${{ github.workspace }}/artifacts:/app/artifacts \
            b2v-pages \
            bash -c 'Xvfb :99 -screen 0 1920x1080x24 &
                     sleep 2
                     npx playwright test --retries=1 --reporter=list'

          # Flatten artifact dirs into videos-fast/<name>/
          mkdir -p videos-fast
          for dir in artifacts/*.test-*; do
            name=$(basename "$dir" | sed 's/\.test-.*//')
            mkdir -p "videos-fast/$name"
            cp "$dir"/run.mp4 "videos-fast/$name/run.mp4" 2>/dev/null || true
            cp "$dir"/captions.vtt "videos-fast/$name/captions.vtt" 2>/dev/null || true
          done

      - name: Upload fast-mode videos
        uses: actions/upload-artifact@v4
        with:
          name: scenario-videos-fast
          path: videos-fast/
          if-no-files-found: warn

  # ── 2. Build site + assemble with videos ──
  build:
    runs-on: ubuntu-latest
    needs: [record-human, record-fast-docker]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js (LTS)
        uses: actions/setup-node@v4
        with:
          node-version: lts/*

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10.29.3

      - name: Install deps
        run: pnpm install --frozen-lockfile

      - name: Build Docusaurus site
        run: pnpm --filter browser2video-website build

      - name: Download human-mode videos
        uses: actions/download-artifact@v4
        with:
          name: scenario-videos-human
          path: website/build/videos

      - name: Download fast-mode videos
        uses: actions/download-artifact@v4
        with:
          name: scenario-videos-fast
          path: website/build/videos-fast

      - name: Generate videos index page
        run: |
          cat > website/build/videos/index.html << 'HTMLEOF'
          <!DOCTYPE html>
          <html lang="en">
          <head>
            <meta charset="utf-8" />
            <meta name="viewport" content="width=device-width, initial-scale=1" />
            <title>Browser2Video — Scenario Demos</title>
            <style>
              :root { --bg: #0a0a0a; --card: #161616; --border: #2a2a2a; --text: #e0e0e0; --muted: #888; --accent: #6b9eff; }
              * { margin: 0; padding: 0; box-sizing: border-box; }
              body { background: var(--bg); color: var(--text); font-family: system-ui, -apple-system, sans-serif; padding: 2rem; }
              h1 { font-size: 1.75rem; font-weight: 700; margin-bottom: 0.5rem; }
              h2 { font-size: 1.35rem; font-weight: 600; margin: 2.5rem 0 0.5rem; }
              .subtitle { color: var(--muted); margin-bottom: 2rem; font-size: 0.95rem; }
              .section-desc { color: var(--muted); margin-bottom: 1rem; font-size: 0.9rem; }
              .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(560px, 1fr)); gap: 1.5rem; }
              .card { background: var(--card); border: 1px solid var(--border); border-radius: 12px; overflow: hidden; }
              .card video { width: 100%; display: block; background: #000; }
              .card-info { padding: 0.75rem 1rem; display: flex; justify-content: space-between; align-items: center; }
              .card-title { font-weight: 600; font-size: 1rem; }
              .card-badge { font-size: 0.7rem; padding: 2px 8px; border-radius: 6px; background: #2a2a2a; color: var(--muted); margin-left: 0.5rem; }
              .card-links { display: flex; gap: 0.75rem; }
              .card-links a { color: var(--accent); text-decoration: none; font-size: 0.85rem; }
              .card-links a:hover { text-decoration: underline; }
              .back { display: inline-block; margin-bottom: 1.5rem; color: var(--accent); text-decoration: none; font-size: 0.9rem; }
              .back:hover { text-decoration: underline; }
              @media (max-width: 640px) { .grid { grid-template-columns: 1fr; } body { padding: 1rem; } }
            </style>
          </head>
          <body>
            <a class="back" href="/">← Back to docs</a>
            <h1>Scenario Demo Videos</h1>
            <p class="subtitle">Auto-generated from the latest <code>main</code> branch.</p>

            <h2>Human Mode (with narration)</h2>
            <p class="section-desc">Recorded with human-like cursor movement, typing delays, and TTS narration.</p>
            <div class="grid" id="grid-human"></div>

            <h2>Fast Mode — Docker (no narration)</h2>
            <p class="section-desc">Same scenarios running in fast mode inside a Docker container. No animations or narration.</p>
            <div class="grid" id="grid-fast"></div>

            <script>
              const scenarios = ['basic-ui','collab','kanban','tui-terminals','console-logs','github-mobile'];

              function buildCards(gridId, baseDir) {
                const grid = document.getElementById(gridId);
                scenarios.forEach(s => {
                  const mp4 = baseDir + '/' + s + '/run.mp4';
                  const vtt = baseDir + '/' + s + '/captions.vtt';
                  const card = document.createElement('div');
                  card.className = 'card';
                  card.innerHTML =
                    '<video controls preload="metadata">' +
                      '<source src="' + mp4 + '" type="video/mp4" />' +
                      '<track kind="subtitles" src="' + vtt + '" srclang="en" label="Steps" default />' +
                    '</video>' +
                    '<div class="card-info">' +
                      '<span class="card-title">' + s + '</span>' +
                      '<span class="card-links">' +
                        '<a href="' + mp4 + '" download>Download MP4</a>' +
                        '<a href="' + vtt + '">Subtitles</a>' +
                      '</span>' +
                    '</div>';
                  grid.appendChild(card);
                });
              }

              buildCards('grid-human', '/videos');
              buildCards('grid-fast', '/videos-fast');
            </script>
          </body>
          </html>
          HTMLEOF

      - name: Upload Pages artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: website/build

  # ── 3. Deploy to GitHub Pages ──
  deploy:
    runs-on: ubuntu-latest
    needs: build
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
