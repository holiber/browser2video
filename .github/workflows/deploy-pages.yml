name: deploy-pages

on:
  push:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: true

jobs:
  # ── 1. Record scenario videos ──
  record-videos:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js (LTS)
        uses: actions/setup-node@v4
        with:
          node-version: lts/*

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10.29.3

      - name: Install system deps
        run: |
          sudo apt-get update
          sudo apt-get install -y xvfb xterm ffmpeg mc htop vim

      - name: Install deps
        run: pnpm install --frozen-lockfile

      - name: Install Playwright browsers
        run: npx playwright install --with-deps chromium

      - name: Record all scenarios
        env:
          NODE_OPTIONS: '--experimental-transform-types'
        run: |
          export DISPLAY=:99
          Xvfb :99 -screen 0 1920x1080x24 &
          sleep 2

          scenarios=(basic-ui collab kanban tui-terminals console-logs github-mobile)
          for s in "${scenarios[@]}"; do
            echo "════════════════════════════════════════"
            echo " Recording: $s"
            echo "════════════════════════════════════════"
            node tests/scenarios/$s.test.ts \
              || echo "⚠ Scenario $s failed (non-fatal)"
          done

          # Flatten artifact dirs: copy run.mp4 and captions.vtt into videos/<name>/
          mkdir -p videos
          for dir in artifacts/*.test-*; do
            name=$(basename "$dir" | sed 's/\.test-.*//')
            mkdir -p "videos/$name"
            cp "$dir"/run.mp4 "videos/$name/run.mp4" 2>/dev/null || true
            cp "$dir"/captions.vtt "videos/$name/captions.vtt" 2>/dev/null || true
          done

      - name: Upload recorded videos
        uses: actions/upload-artifact@v4
        with:
          name: scenario-videos
          path: videos/
          if-no-files-found: warn

  # ── 2. Build site + assemble with videos ──
  build:
    runs-on: ubuntu-latest
    needs: record-videos
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js (LTS)
        uses: actions/setup-node@v4
        with:
          node-version: lts/*

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10.29.3

      - name: Install deps
        run: pnpm install --frozen-lockfile

      - name: Build Docusaurus site
        run: pnpm --filter browser2video-website build

      - name: Download scenario videos
        uses: actions/download-artifact@v4
        with:
          name: scenario-videos
          path: website/build/videos

      - name: Generate videos index page
        run: |
          cat > website/build/videos/index.html << 'HTMLEOF'
          <!DOCTYPE html>
          <html lang="en">
          <head>
            <meta charset="utf-8" />
            <meta name="viewport" content="width=device-width, initial-scale=1" />
            <title>Browser2Video — Scenario Demos</title>
            <style>
              :root { --bg: #0a0a0a; --card: #161616; --border: #2a2a2a; --text: #e0e0e0; --muted: #888; --accent: #6b9eff; }
              * { margin: 0; padding: 0; box-sizing: border-box; }
              body { background: var(--bg); color: var(--text); font-family: system-ui, -apple-system, sans-serif; padding: 2rem; }
              h1 { font-size: 1.75rem; font-weight: 700; margin-bottom: 0.5rem; }
              .subtitle { color: var(--muted); margin-bottom: 2rem; font-size: 0.95rem; }
              .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(560px, 1fr)); gap: 1.5rem; }
              .card { background: var(--card); border: 1px solid var(--border); border-radius: 12px; overflow: hidden; }
              .card video { width: 100%; display: block; background: #000; }
              .card-info { padding: 0.75rem 1rem; display: flex; justify-content: space-between; align-items: center; }
              .card-title { font-weight: 600; font-size: 1rem; }
              .card-links { display: flex; gap: 0.75rem; }
              .card-links a { color: var(--accent); text-decoration: none; font-size: 0.85rem; }
              .card-links a:hover { text-decoration: underline; }
              .back { display: inline-block; margin-bottom: 1.5rem; color: var(--accent); text-decoration: none; font-size: 0.9rem; }
              .back:hover { text-decoration: underline; }
              @media (max-width: 640px) { .grid { grid-template-columns: 1fr; } body { padding: 1rem; } }
            </style>
          </head>
          <body>
            <a class="back" href="/">← Back to docs</a>
            <h1>Scenario Demo Videos</h1>
            <p class="subtitle">Auto-generated from the latest <code>main</code> branch. Each video shows a scenario running in human mode.</p>
            <div class="grid" id="grid"></div>
            <script>
              const scenarios = ['basic-ui','collab','kanban','tui-terminals','console-logs','github-mobile'];
              const grid = document.getElementById('grid');
              scenarios.forEach(s => {
                const mp4 = s + '/run.mp4';
                const vtt = s + '/captions.vtt';
                const card = document.createElement('div');
                card.className = 'card';
                card.innerHTML = `
                  <video controls preload="metadata" poster="">
                    <source src="${mp4}" type="video/mp4" />
                    <track kind="subtitles" src="${vtt}" srclang="en" label="Steps" default />
                  </video>
                  <div class="card-info">
                    <span class="card-title">${s}</span>
                    <span class="card-links">
                      <a href="${mp4}" download>Download MP4</a>
                      <a href="${vtt}">Subtitles</a>
                    </span>
                  </div>`;
                grid.appendChild(card);
              });
            </script>
          </body>
          </html>
          HTMLEOF

      - name: Upload Pages artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: website/build

  # ── 3. Deploy to GitHub Pages ──
  deploy:
    runs-on: ubuntu-latest
    needs: build
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
