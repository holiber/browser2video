name: deploy-pages

on:
  push:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: true

jobs:
  # ── 1a. Record human-mode scenario videos (with narration) ──
  record-human:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js (LTS)
        uses: actions/setup-node@v4
        with:
          node-version: lts/*

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10.29.3

      - name: Install system deps
        run: |
          sudo apt-get update
          sudo apt-get install -y xvfb xterm ffmpeg mc htop vim

      - name: Install deps
        run: pnpm install --frozen-lockfile

      - name: Install Playwright browsers
        run: npx playwright install --with-deps chromium

      - name: Record all scenarios (human mode)
        env:
          NODE_OPTIONS: '--experimental-transform-types'
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          export DISPLAY=:99
          Xvfb :99 -screen 0 1920x1080x24 &
          sleep 2

          scenarios=(basic-ui collab kanban tui-terminals console-logs github-mobile carousel-demo)
          for s in "${scenarios[@]}"; do
            echo "════════════════════════════════════════"
            echo " Recording: $s (human mode)"
            echo "════════════════════════════════════════"
            node tests/scenarios/$s.test.ts \
              || echo "⚠ Scenario $s failed (non-fatal)"
          done

          # Flatten artifact dirs: copy run.mp4 and captions.vtt into videos/<name>/
          mkdir -p videos
          for dir in artifacts/*.test-*; do
            name=$(basename "$dir" | sed 's/\.test-.*//')
            mkdir -p "videos/$name"
            cp "$dir"/run.mp4 "videos/$name/run.mp4" 2>/dev/null || true
            cp "$dir"/captions.vtt "videos/$name/captions.vtt" 2>/dev/null || true
          done

      - name: Upload human-mode videos
        uses: actions/upload-artifact@v4
        with:
          name: scenario-videos-human
          path: videos/
          if-no-files-found: warn

  # ── 1b. Record fast-mode scenario videos in Docker (no narration) ──
  record-fast-docker:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    continue-on-error: true   # Don't block deploy if Docker tests are flaky
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker image (cached)
        uses: docker/build-push-action@v6
        with:
          context: .
          load: true
          tags: b2v-pages:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Record all scenarios (fast mode, Docker)
        run: |
          mkdir -p artifacts
          docker run --rm \
            --ipc=host \
            -e B2V_MODE=fast \
            -e DISPLAY=:99 \
            -v ${{ github.workspace }}/artifacts:/app/artifacts \
            b2v-pages \
            bash -c 'Xvfb :99 -screen 0 1920x1080x24 &
                     sleep 2
                     npx playwright test --retries=2 --reporter=list'

          # Flatten artifact dirs into videos-fast/<name>/
          mkdir -p videos-fast
          for dir in artifacts/*.test-*; do
            name=$(basename "$dir" | sed 's/\.test-.*//')
            mkdir -p "videos-fast/$name"
            cp "$dir"/run.mp4 "videos-fast/$name/run.mp4" 2>/dev/null || true
            cp "$dir"/captions.vtt "videos-fast/$name/captions.vtt" 2>/dev/null || true
          done

      - name: Upload fast-mode videos
        uses: actions/upload-artifact@v4
        with:
          name: scenario-videos-fast
          path: videos-fast/
          if-no-files-found: warn

  # ── 2. Build site + assemble with videos ──
  build:
    runs-on: ubuntu-latest
    needs: [record-human, record-fast-docker]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js (LTS)
        uses: actions/setup-node@v4
        with:
          node-version: lts/*

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10.29.3

      - name: Install deps
        run: pnpm install --frozen-lockfile

      - name: Build Docusaurus site
        run: pnpm --filter browser2video-website build

      - name: Download human-mode videos
        uses: actions/download-artifact@v4
        with:
          name: scenario-videos-human
          path: website/build/videos

      - name: Download fast-mode videos
        uses: actions/download-artifact@v4
        continue-on-error: true
        with:
          name: scenario-videos-fast
          path: website/build/videos-fast

      - name: Generate videos index page
        env:
          NODE_OPTIONS: '--experimental-transform-types'
        run: |
          node scripts/gen-video-page.ts \
            --out website/build/videos/index.html \
            --human-dir . \
            --fast-dir ../videos-fast

      - name: Upload Pages artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: website/build

  # ── 3. Deploy to GitHub Pages ──
  deploy:
    runs-on: ubuntu-latest
    needs: build
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
